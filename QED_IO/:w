#include <marty.h>
#include <map>

using namespace csl;
using namespace mty;

using std::cout; using std::cin;
using std::endl; using std::string;
using std::map; using std::copy;

int main(int argc, char *argv[])
{

    Model QED;
    AddGaugedGroup(QED, group::Type::U1, "U1_em", constant_s("e"));
    Init(QED);

    Particle electron = diracfermion_s("e", QED);
    SetMass(electron, "m_e");
    SetGroupRep(electron, "U1_em", {-1, 1});
    AddParticle(QED, electron);
    Rename(QED, "A_U1_em", "A");
    Particle photon = GetParticle(QED, "A");

    auto rules = ComputeFeynmanRules(QED);

    map<string, Particle> particles_dic = {
        {"electron", electron},
        {"photon", photon},
    };

    auto pin1 = particles_dic[argv[1]];
    auto pin2 = particles_dic[argv[2]];
    auto pout1 = particles_dic[argv[3]];
    auto pout2 = particles_dic[argv[4]];

    cout << "incoming 1: " << argv[1] << ", " << pin1 << endl;
    cout << "incoming 2: " << argv[2] << ", " << pin2 << endl;
    cout << "outgoing 1: " << argv[3] << ", " << pout1 << endl;
    cout << "outgoing 2: " << argv[4] << ", " << pout2 << endl;


    auto process_ampl = QED.computeAmplitude(Order::TreeLevel,
                                        {Incoming(pin1),
                                         Incoming(pin2),
                                         Outgoing(pout1),
                                         Outgoing(pout2)});

    // Show(process_ampl);
    

    std::cout << "AMPLITUDES:" << std::endl << std::endl;

    for (size_t i = 0; i!=process_ampl.size(); i++){
        std::cout << "i = " << i << std::endl;
        auto diagram_ampl_eval = Evaluated(process_ampl.expression(i), eval::abbreviation);
        Display(diagram_ampl_eval);
    }

    // for (size_t i = 0; i!=process_ampl.size(); i++){
    //     std::cout << "i = " << i << std::endl;
    //     auto square = QED.computeSquaredAmplitude(process_ampl.expression[i]);
    //     auto square_eval = Evaluated(square, eval::abbreviation);
    //     Display(square);
    // }

    cout << "--------------" << endl;
    cout << "amplitude:" << process_ampl.diagrams[1].getExpression() << endl;
    cout << "--------------" << endl;

    auto square = QED.computeSquaredAmplitude(process_ampl);
    auto square_eval = Evaluated(square, eval::abbreviation);
    std::cout << "SQUARED AMPLITUDES:" << std::endl << std::endl;
    Display(square_eval);

    return 0;
}
